name: CI/CD Pipeline

on:
  push:
    tags:
      - v*

jobs:
  build-backend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Initial Branch
        uses: actions/checkout@v4
        with:
          ref: CI-CD-pipline

      - name: Switch to Backend Branch
        run: |
          git fetch origin
          git checkout CI-CD-pipline  
        #  main-backend

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_ACCESS_TOKEN}}

      - name: Extract the latest Git tag
        run: |
          echo "TAG=$(git describe --tags --abbrev=0)" >> $GITHUB_ENV
          echo $TAG

      - name: Build and Push Backend Image
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: noraali/backend:${{ env.TAG }}
          context: . #./backend
          file: ./Dockerfile #./backend/Dockerfile
          

  build-frontend:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout Initial Branch
        uses: actions/checkout@v4
        with:
          ref: CI-CD-pipline

      - name: Switch to frontend Branch
        run: |
          git fetch origin
          git checkout CI-CD-pipline
        # main-frontend

      - name: Log in to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_ACCESS_TOKEN}}

      - name: Extract the latest Git tag
        run: echo "TAG=$(git describe --tags --abbrev=0)" >> $GITHUB_ENV

      - name: Build and Push frontend Image
        uses: docker/build-push-action@v6
        with:
          push: true
          tags: noraali/frontend:${{ env.TAG }}
          context: .  #./frontend
          file: ./Dockerfile #./frontend/Dockerfile



# branches:
#   - CI-CD-pipline
#   - main-backend
#   - main-frontend

# if: github.ref == 'refs/heads/CI-CD-pipline'
# main-backend

